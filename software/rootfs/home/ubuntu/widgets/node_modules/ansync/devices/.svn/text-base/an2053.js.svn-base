var util   = require("util"),
    device = require("./basedevice");

function AN2053(serial, alias, logger) {
    AN2053.super_.call(this,
                       serial,   // Serial number, from args if provided
                       alias,    // Device alias, from args if provided
                       "AN2053", // Model number
                       1,        // Minimum channel, as seen from userspace
                       1,        // Maximum channel, as seen from userspace
                       logger);  // Logger (singleton), from args if provided

    this.parameters.minValue = -1.0;
    this.parameters.maxValue =  1.0;
}
util.inherits(AN2053, device.BaseDevice);

AN2053.prototype.init = function() {
    var rc = new Error("Unknown error");

    rc = this.preInit();
    if (rc instanceof Error) {
        return rc;
    }

    this.boardHandle = this.libvita.AN2053_new(this.portHandle);
    if (this.boardHandle <= 0) {
        return new Error("Failed to bind driver to " + this.getIdentifier());
    }

    this.logger.info("done.");
    return 0;
}

AN2053.prototype.setChannel = function(channel, dutyCycle) {
    var mask;
    var data;
    var rc = -1;
    var direction = 0;

    if (channel < this.minChannel || channel > this.maxChannel) {
        return new Error("Invalid channel for " + this.getIdentifier() + ".  Valid channels are " + this.minChannel + " to " + this.maxChannel);
    }
    if (dutyCycle < -1 || dutyCycle > 1) {
        return new Error("Invalid duty cycle for " + this.getIdentifier() + " Valid values are -1.0 to 1.0");
    }

    if (dutyCycle > 0) {
        direction = 1;
    } else if (dutyCycle < 0) {
        direction = 2;
    }

    rc = this.libvita.AN2053_setMotor(this.bh, direction, dutyCycle, 0);
    if (rc < 0) {
        return new Error("Failed to set duty cycle of " + dutyCycle + " on " + this.getIdentifier());
    } else {
        data = {
            type: "Digital",
            value: dutyCycle
        };

        this.emit("ansync-data", this.serial, this.alias, this.model, channel, data);
    }
}

AN2053.prototype.getChannel = function(channel) {

}

AN2053.prototype.button = function(channel, dutyCycle) {
    this.setChannel(channel, dutyCycle);
}

exports.AN2053 = AN2053;

