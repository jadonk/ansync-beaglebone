var dx, dy, right, up, left, down, rotation, go = true;

$(function() {
	setInterval(function(){

		dx = joystick1.deltaX();
		dy = joystick1.deltaY();
		right = joystick1.right() || null;
		up = joystick1.up() || null;
		left = joystick1.left() || null;
		down = joystick1.down() || null;
		rotation = joystick2.deltaX();
		if (dx || dy || rotation) go = true;

		var payload = {};
		payload.dx = dx;
		payload.dy = dy;
		payload.up = up;
		payload.down = down;
		payload.left = left;
		payload.right = right;
		payload.rotation = rotation;
		if (go) postData(payload);
		if (!dx && !dy && !rotation) go = false;
	}, 150);
});

var speed,
    button_map = {
    81: {cmd: "move", data: {X:  1, Y:  0, R:  0}}, // Up-Left
    87: {cmd: "move", data: {X:  1, Y:  1, R:  0}}, // Up
    69: {cmd: "move", data: {X:  0, Y:  1, R:  0}}, // Up-Right
    65: {cmd: "move", data: {X:  1, Y: -1, R:  0}}, // Left
    83: {cmd: "stop", data: {X:  0, Y:  0, R:  0}}, // Stop
    68: {cmd: "move", data: {X: -1, Y:  1, R:  0}}, // Right
    90: {cmd: "move", data: {X:  0, Y: -1, R:  0}}, // Down-Left
    88: {cmd: "move", data: {X: -1, Y: -1, R:  0}}, // Down
    67: {cmd: "move", data: {X: -1, Y:  0, R:  0}}, // Down-Right
    16: {cmd: "move", data: {X:  0, Y:  0, R: -1}}, // Rotate CCW
    86: {cmd: "move", data: {X:  0, Y:  0, R:  1}}  // Rotate CW
};

$(document).ready(function() {
    //express's static directory parsing ruins image link...
    var foo  = "http://" + window.location.hostname + ":8090/?action=stream";
    document.getElementById("webcam").src = foo;
    console.log(foo);
    //var cw = $('td').css('height');
    //$('td').css('width', cw + 'px');
});


var postData = function(payload) {
    $.ajax({
	url: "move",
	type: "POST",
	data: payload
    });
};

