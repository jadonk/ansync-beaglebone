var time = 2.5;

$(function() {
    //var cw = $('td').css('height');
    //$('td').css('width', cw + 'px');

    $("#speed").slider({
        value: 50,
        min: 0,
        max: 100,
        step: 25,
        slide: function(event, ui) {
            $("#speedbox").val(ui.value + "%");
        },
        change: function() {
            $("#speedbox").val($("#speed").slider("value") + "%");
        }
    });
    $("#speedbox").val($("#speed").slider("value") + "%");

    $("#time").slider({
        value: 2500,
        min: 0,
        max: 5000,
        step: 100,
        slide: function(event, ui) {
            $("#timebox").val(ui.value/1000 + " seconds");
        },
        change: function() {
            time = $("#time").slider("value")/1000;
            console.log(time + " second" + (time == 1)?"":"s");
        $("#timebox").val(time + " second" + ((time == 1)?"":"s"));
        }
    });
    $("#timebox").val(time + " second" + ((time == 1)?"":"s"));

    $("#xslider").slider({
        value: 0,
        min: -100,
        max: 100,
        step: 10,
        slide: function(event, ui) {
            $("#xbox").val(ui.value + "%");
        },
        change: function() {
            $("#xbox").val($("#xslider").slider("value") + "%");
        }
    });
    $("#xbox").val($("#xslider").slider("value") + "%");

    $("#yslider").slider({
        value: 0,
        min: -100,
        max: 100,
        step: 10,
        slide: function(event, ui) {
            $("#ybox").val(ui.value + "%");
        },
        change: function() {
            $("#ybox").val($("#yslider").slider("value") + "%");
        }
    });
    $("#ybox").val($("#yslider").slider("value") + "%");

    $("#rslider").slider({
        value: 0,
        min: -360,
        max: 360,
        step: 5,
        slide: function(event, ui) {
            $("#rbox").val(ui.value + " degrees");
        },
        change: function() {
            $("#rbox").val($("#rslider").slider("value") + " degrees");
        }
    });
    $("#rbox").val($("#rslider").slider("value") + " degrees");

    $("input:submit").button();
    $("input:submit").click(function() {
                      postData({cmd: "move",
                                data: {
                              X: $("#xslider").slider("value")/100,
                              Y: $("#yslider").slider("value")/100,
                              R: $("#rslider").slider("value")/360
                                      }
                               })
    });
});

var speed,
    button_map = {
    81: {cmd: "move", data: {X: -1, Y:  1, R:  0}},
    87: {cmd: "move", data: {X:  0, Y:  1, R:  0}},
    69: {cmd: "move", data: {X:  1, Y:  1, R:  0}},
    65: {cmd: "move", data: {X: -1, Y:  0, R:  0}},
    83: {cmd: "stop", data: {X:  0, Y:  0, R:  0}}, //Stop button
    68: {cmd: "move", data: {X:  1, Y:  0, R:  0}},
    90: {cmd: "move", data: {X: -1, Y: -1, R:  0}},
    88: {cmd: "move", data: {X:  0, Y: -1, R:  0}},
    67: {cmd: "move", data: {X:  1, Y: -1, R:  0}},
    16: {cmd: "move", data: {X:  0, Y:  0, R: -1}},
    86: {cmd: "move", data: {X:  0, Y:  0, R:  1}}
};

// keyboard controls
$(document).keydown(function (evt) {
    var dir = button_map[evt.which];
    if (dir !== undefined && evt.which != 192) {
      evt.preventDefault();
      postData(dir);
    }
});

// mouse controls - must wait until DOM is ready...
$(document).ready(function() {
    $(".btn").mousedown(function (evt) {
        var dir = button_map[$(evt.target).data('key')];
        if (dir !== undefined) {
            evt.preventDefault();
            postData(dir);
        }
    });

    //express's static directory parsing ruins image link...
    var foo  = "http://" + window.location.host + ":8090/?action=stream";
    document.getElementById("webcam").src = foo;
    console.log(foo);
    //var cw = $('td').css('height');
    //$('td').css('width', cw + 'px');
});

// touchscreen device controls
$('.btn').bind('touchstart', function(evt) {
    var dir = button_map[$(this).data('key')];
    postData(dir);
});

var postData = function(payload) {
    payload.data.speed = $("#speed").slider("value");
    payload.data.time  = $("#time").slider("value");

    $.ajax({
        url: "move",
        type: "POST",
        data: payload,
        success: function(data) {
            if (data.error) {
                console.log(data.error);
                alert(data.error);
            }
        }
    });
};

var getData = function() {
    $.ajax({
        url: "speed",
        type: "GET",
        success: function(data) {
            speed = data.speed;
        },
        error: function (request, type, errorThrown) {
            var message = "There was an error with the AJAX request.\n";
            switch (type) {
            case 'timeout':
                message += "The request timed out.";
                break;
            case 'notmodified':
                message += "The request was not modified but was not retrieved from the cache.";
                break;
            case 'parsererror':
                message += "XML/Json format is bad.";
                break;
            default:
                message += "HTTP Error (" + request.status + " " + request.statusText + ").";
            }
            message += "\n";
            alert(message);
        }
    });
};

getData();
