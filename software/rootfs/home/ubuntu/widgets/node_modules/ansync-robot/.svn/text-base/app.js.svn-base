var anrobot  = require('./anrobot'),
    speed    = 50, //in percent
    robots   = require('./robots.json');

function link(app, express) {
    var robot, robot_name;

    for (robot_name in robots) {
        if (robots.hasOwnProperty(robot_name)) {
            robot = robots[robot_name];
            initHttpHandlers(app, express, robot_name, robot.page_title);
        }
    }
    return robots;
}

// HTTP request handlers
function initHttpHandlers(app, express, robot_name, page_title) {
    var url = "/" + robot_name;

    app.use(url, express.static(__dirname + '/public'));

    app.get(url, function (req, res) {
        res.render(__dirname + '/public/jade/layout', {title: page_title});
    });

    app.post(url + '/move', function (req, res) {
        //console.log("Received POST request");

        var error;

        if (error = isBadJSON(req.body)) {
            console.log('Bad request!');
            console.log(error);

            res.send(400);
            return;
        }

        speed = req.body.data.speed;

        switch (req.body.cmd) {
        case 'move':
            error = anrobot.startMotors(robots[robot_name], req.body.data, res);
            if (error) {
                //if error, send complete response back immediately as timeout
                //will never be called
                res.send({error: error});
            }
            break;
        case 'stop':
            error = anrobot.stopMotors(robots[robot_name]);
            res.send(200, {error: error});
            break;
        default:
            res.send(400);
            break;
        }
    });

    app.get(url + '/speed', function (req, res) {
        res.send({speed: speed});
    });
}

/******************** Helper Functions ********************/
function isBadJSON(obj) {

    if (obj === undefined) {
        return "obj undefined";
    }

    if (obj.cmd === undefined) {
        return "cmd undefined";
    }

    if (obj.data === undefined) {
        return "data undefined!";
    }

    obj = obj.data;

    if (obj.X === undefined || obj.Y === undefined ||
        obj.R === undefined || obj.speed === undefined ||
        obj.time === undefined) {
        return 'property of data undefined';
    }
    return false;
}

exports.link = link;
